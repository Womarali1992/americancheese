name: Deploy Backend to Digital Ocean

on:
  push:
    branches:
      - main
    paths:
      - 'americancheese/**'
  workflow_dispatch: # Allow manual triggering

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install SSH key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          known_hosts: unnecessary
          if_key_exists: replace

      - name: Adding Known Hosts
        run: ssh-keyscan -H 178.128.118.54 >> ~/.ssh/known_hosts

      - name: Deploy to Digital Ocean
        run: |
          echo "Deploying americancheese backend..."
          ssh -i ~/.ssh/id_rsa root@178.128.118.54 << 'ENDSSH'
          set -e
          echo "Starting deployment process..."

          # Create app directory if it doesn't exist
          mkdir -p /var/www/americancheese
          cd /var/www/americancheese

          # Clone or pull the repository
          if [ ! -d ".git" ]; then
            echo "Cloning repository for the first time..."
            cd /var/www
            rm -rf americancheese
            git clone https://github.com/${{ github.repository }}.git americancheese
            cd americancheese
          else
            echo "Pulling latest changes..."
            git fetch origin
            git reset --hard origin/main
          fi

          # Navigate to the americancheese subfolder (where the actual app is)
          cd /var/www/americancheese/americancheese

          # Load NVM
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
          nvm use 18 || nvm install 18

          # Install dependencies
          npm install

          # Build the application
          npm run build

          # Configure production database credentials
          echo "Setting up production database..."

          # Create realestateos database if it doesn't exist
          sudo -u postgres psql -c "CREATE DATABASE realestateos;" 2>/dev/null || echo "Database realestateos already exists"

          # Run data migration (ignore errors)
          echo "Running data migration..."
          sudo -u postgres psql -d realestateos -f export-superx.sql || true
          echo "Projects in database:"
          sudo -u postgres psql -d realestateos -c "SELECT id, name FROM projects;" || true

          # Run database fixes
          echo "Running database fixes..."
          sudo -u postgres psql -d realestateos -c "UPDATE tasks SET calendar_active = false WHERE calendar_active IS NULL;" || true
          sudo -u postgres psql -d realestateos -c "UPDATE subtasks SET calendar_active = false WHERE calendar_active IS NULL;" || true
          echo "Database fixes applied"

          # Create production .env with individual DB variables (app uses these, not DATABASE_URL)
          echo "NODE_ENV=production" > .env
          echo "PORT=5001" >> .env
          echo "DB_HOST=localhost" >> .env
          echo "DB_PORT=5432" >> .env
          echo "DB_NAME=realestateos" >> .env
          echo "DB_USER=postgres" >> .env
          echo "DB_PASSWORD=richman" >> .env
          echo "DATABASE_URL=postgresql://postgres:richman@localhost:5432/realestateos" >> .env
          echo "SESSION_SECRET=$(openssl rand -hex 32)" >> .env
          chmod 600 .env
          echo "Production .env configured with realestateos database"

          # Run database schema push (creates missing tables/columns)
          echo "Pushing database schema..."
          npm run db:push 2>&1 || echo "db:push had issues"

          # Stop any existing PM2 process
          pm2 delete americancheese 2>/dev/null || true

          # Start the app with PM2 on port 5001 (production nginx config)
          PORT=5001 pm2 start npm --name americancheese -- run start
          pm2 save

          # Wait for app to start
          echo "Waiting for app to start..."
          sleep 8

          # Check database connection and show projects
          echo "Testing database connection..."
          echo "=== PROJECTS IN REALESTATEOS DATABASE ==="
          sudo -u postgres psql -d realestateos -c "SELECT id, name FROM projects ORDER BY id;" || echo "DB query failed!"
          echo "=== END PROJECTS ==="
          
          # Check if app is running on port 5001
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:5001/api/projects 2>/dev/null || echo "000")
          echo "API health check: HTTP $HTTP_CODE"
          
          # Show recent logs regardless
          echo "Recent PM2 logs:"
          pm2 logs americancheese --lines 50 --nostream 2>/dev/null || true

          # Fix Nginx to proxy to port 5001 for sitesetups
          echo "Checking Nginx config for sitesetups..."
          if grep -q "proxy_pass http://localhost:5000" /etc/nginx/sites-available/americancheese 2>/dev/null; then
            echo "Fixing Nginx to use port 5001..."
            sudo sed -i 's/proxy_pass http:\/\/localhost:5000/proxy_pass http:\/\/localhost:5001/g' /etc/nginx/sites-available/americancheese
            sudo nginx -t && sudo systemctl reload nginx
            echo "Nginx updated to port 5001"
          else
            echo "Nginx config already correct or not found"
          fi

          echo "Deployment complete!"
          ENDSSH
