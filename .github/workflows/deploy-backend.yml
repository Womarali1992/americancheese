name: Deploy Backend to Digital Ocean

on:
  push:
    branches:
      - main
    paths:
      - 'americancheese/**'
  workflow_dispatch: # Allow manual triggering

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install SSH key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          known_hosts: unnecessary
          if_key_exists: replace

      - name: Adding Known Hosts
        run: ssh-keyscan -H 134.199.207.43 >> ~/.ssh/known_hosts

      - name: Deploy to Digital Ocean
        run: |
          echo "Deploying americancheese backend..."
          ssh -i ~/.ssh/id_rsa root@134.199.207.43 << 'ENDSSH'
          set -e
          echo "Starting deployment process..."

          # Create app directory if it doesn't exist
          mkdir -p /var/www/americancheese
          cd /var/www/americancheese

          # Clone or pull the repository
          if [ ! -d ".git" ]; then
            echo "Cloning repository for the first time..."
            cd /var/www
            rm -rf americancheese
            git clone https://github.com/${{ github.repository }}.git americancheese
            cd americancheese
          else
            echo "Pulling latest changes..."
            git fetch origin
            git reset --hard origin/main
          fi

          # Navigate to the americancheese subfolder (where the actual app is)
          cd /var/www/americancheese/americancheese

          # Install Node.js 18 from NodeSource (always runs to ensure latest)
          echo "Setting up Node.js 18..."
          curl -fsSL https://deb.nodesource.com/setup_18.x -o /tmp/nodesource_setup.sh
          sudo bash /tmp/nodesource_setup.sh
          sudo apt-get install -y nodejs
          echo "Node version: $(node -v)"
          echo "NPM version: $(npm -v)"

          # Install PM2 globally if not present
          which pm2 || sudo npm install -g pm2

          # Install dependencies
          npm install

          # Build the application
          npm run build

          # Configure production database credentials
          echo "Setting up production database..."

          # Check if PostgreSQL is running
          echo "Checking PostgreSQL status..."
          sudo systemctl status postgresql 2>&1 || true
          sudo systemctl start postgresql 2>&1 || true
          
          # List existing databases
          echo "=== Existing databases ==="
          sudo -u postgres psql -l 2>&1 || echo "Could not list databases"
          
          # Ensure americancheese database and user exist
          echo "Setting up americancheese database..."
          sudo -u postgres createdb americancheese 2>&1 || echo "Database may already exist"
          sudo -u postgres psql -c "CREATE USER americancheese WITH PASSWORD 'richman';" 2>&1 || echo "User may already exist"
          sudo -u postgres psql -c "ALTER USER americancheese WITH PASSWORD 'richman';" 2>&1 || echo "Password set failed"
          sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE americancheese TO americancheese;" 2>&1
          sudo -u postgres psql -d americancheese -c "GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO americancheese;" 2>&1 || true
          sudo -u postgres psql -d americancheese -c "GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO americancheese;" 2>&1 || true

          # Also set postgres password for backward compatibility
          sudo -u postgres psql -c "ALTER USER postgres WITH PASSWORD 'richman';" 2>&1 || echo "Password set failed"

          # Verify database exists
          echo "=== Verifying database exists ==="
          sudo -u postgres psql -l 2>&1 | grep americancheese || echo "WARNING: americancheese not found in database list!"

          # Test connection with password
          echo "Testing database connection..."
          PGPASSWORD=richman psql -h localhost -U americancheese -d americancheese -c "SELECT 1;" 2>&1 || echo "Connection test failed"

          # Create production .env FIRST (needed for db:push)
          # IMPORTANT: Preserve existing SESSION_SECRET to prevent user disconnections
          EXISTING_SESSION_SECRET=""
          if [ -f .env ]; then
            EXISTING_SESSION_SECRET=$(grep "^SESSION_SECRET=" .env | cut -d'=' -f2 || echo "")
          fi

          echo "NODE_ENV=production" > .env
          echo "PORT=5001" >> .env
          echo "DB_HOST=localhost" >> .env
          echo "DB_PORT=5432" >> .env
          echo "DB_NAME=americancheese" >> .env
          echo "DB_USER=americancheese" >> .env
          echo "DB_PASSWORD=richman" >> .env
          echo "DATABASE_URL=postgresql://americancheese:richman@localhost:5432/americancheese" >> .env

          # Reuse existing SESSION_SECRET or generate new one only on first deploy
          if [ -n "$EXISTING_SESSION_SECRET" ]; then
            echo "SESSION_SECRET=$EXISTING_SESSION_SECRET" >> .env
            echo "Preserved existing SESSION_SECRET (users stay logged in)"
          else
            echo "SESSION_SECRET=$(openssl rand -hex 32)" >> .env
            echo "Generated new SESSION_SECRET (first deployment)"
          fi

          chmod 600 .env
          echo "Production .env configured with americancheese database"

          # Run database schema push FIRST (creates tables)
          echo "Pushing database schema to create tables..."
          npm run db:push 2>&1
          echo "Schema push complete"

          # Grant permissions AFTER schema push (to include any new tables)
          echo "Granting permissions to americancheese user..."
          sudo -u postgres psql -d americancheese -c "GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO americancheese;" 2>&1
          sudo -u postgres psql -d americancheese -c "GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO americancheese;" 2>&1
          sudo -u postgres psql -d americancheese -c "ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO americancheese;" 2>&1
          sudo -u postgres psql -d americancheese -c "ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON SEQUENCES TO americancheese;" 2>&1
          echo "Permissions granted"

          # Run database fixes (americancheese database already has data)
          echo "Running database fixes..."
          sudo -u postgres psql -d americancheese -c "UPDATE tasks SET calendar_active = false WHERE calendar_active IS NULL;" || true
          sudo -u postgres psql -d americancheese -c "UPDATE subtasks SET calendar_active = false WHERE calendar_active IS NULL;" || true
          echo "Database fixes applied"

          # Show current projects
          echo "Projects in database:"
          sudo -u postgres psql -d americancheese -c "SELECT id, name FROM projects ORDER BY id;" || true

          # Run database verification
          echo "Verifying database state..."
          export DB_HOST=localhost
          export DB_PORT=5432
          export DB_NAME=americancheese
          export DB_USER=americancheese
          export DB_PASSWORD=richman
          node check-db-state.js || echo "Verification script failed"

          # Create PM2 ecosystem config for consistent deployments
          cat > ecosystem.config.cjs << 'PMEOF'
          module.exports = {
            apps: [{
              name: 'americancheese',
              script: 'npm',
              args: 'run start',
              cwd: '/var/www/americancheese/americancheese',
              env: {
                NODE_ENV: 'production',
                PORT: 5001,
                DB_HOST: 'localhost',
                DB_PORT: 5432,
                DB_NAME: 'americancheese',
                DB_USER: 'americancheese',
                DB_PASSWORD: 'richman'
              },
              watch: false,
              max_memory_restart: '500M',
              error_file: '/var/log/americancheese/error.log',
              out_file: '/var/log/americancheese/out.log'
            }]
          };
          PMEOF

          # Create log directory
          sudo mkdir -p /var/log/americancheese
          sudo chmod 755 /var/log/americancheese

          # Zero-downtime restart: Use reload if process exists, otherwise start fresh
          if pm2 describe americancheese > /dev/null 2>&1; then
            echo "Reloading existing PM2 process (zero-downtime)..."
            pm2 reload ecosystem.config.cjs --update-env
          else
            echo "Starting new PM2 process..."
            pm2 start ecosystem.config.cjs
          fi
          pm2 save

          # Wait for app to start
          echo "Waiting for app to start..."
          sleep 8

          # Check database connection and show projects
          echo "Testing database connection..."
          echo "=== PROJECTS IN AMERICANCHEESE DATABASE ==="
          sudo -u postgres psql -d americancheese -c "SELECT id, name FROM projects ORDER BY id;" || echo "DB query failed!"
          echo "=== USERS IN DATABASE ==="
          sudo -u postgres psql -d americancheese -c "SELECT id, email, name FROM users ORDER BY id;" || echo "Users query failed!"
          echo "=== END VERIFICATION ==="
          
          # Check if app is running on port 5001
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:5001/api/projects 2>/dev/null || echo "000")
          echo "API health check: HTTP $HTTP_CODE"
          
          # If 500, get the actual error
          if [ "$HTTP_CODE" = "500" ]; then
            echo "=== API ERROR RESPONSE ==="
            curl -s http://localhost:5001/api/projects 2>/dev/null || echo "Could not get response"
            echo "=== END ERROR ==="
          fi
          
          # Show recent logs regardless
          echo "Recent PM2 logs:"
          pm2 logs americancheese --lines 100 --nostream 2>/dev/null || true

          # Update Nginx config from repo
          echo "Updating Nginx configuration..."
          if [ -f "/var/www/americancheese/americancheese/deploy/nginx.conf" ]; then
            # Copy the config
            sudo cp /var/www/americancheese/americancheese/deploy/nginx.conf /etc/nginx/sites-available/americancheese

            # Update server_name to sitesetups.com
            sudo sed -i 's/YOUR_DOMAIN_OR_IP/sitesetups.com/g' /etc/nginx/sites-available/americancheese

            # Ensure symlink exists
            sudo ln -sf /etc/nginx/sites-available/americancheese /etc/nginx/sites-enabled/americancheese

            # Test and reload
            if sudo nginx -t; then
              sudo systemctl reload nginx
              echo "Nginx config updated and reloaded successfully"
            else
              echo "Nginx config test failed - keeping old config"
            fi
          else
            echo "No nginx.conf found in deploy folder, checking for port fixes..."
            # Fallback: Fix Nginx to proxy to port 5001 for all relevant configs
            for config in /etc/nginx/sites-enabled/*; do
              if grep -q "proxy_pass http://localhost:5000" "$config" 2>/dev/null; then
                echo "Fixing Nginx config: $config to use port 5001..."
                sudo sed -i 's/proxy_pass http:\/\/localhost:5000/proxy_pass http:\/\/localhost:5001/g' "$config"
                NGINX_RELOAD=true
              fi
            done

            if [ "$NGINX_RELOAD" = true ]; then
              sudo nginx -t && sudo systemctl reload nginx
              echo "Nginx reloaded with port 5001"
            fi
          fi

          echo "Deployment complete!"
          ENDSSH
